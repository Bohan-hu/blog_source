---
title: MIPS流水线扩展：多周期操作
date: 2019-08-24 22:20:23
tags: Architecture
---



# MIPS流水线扩展：多周期操作

- 例如，浮点运算需要多个周期完成，EX周期可能会重复多次
- 在本节中，假定MIPS实现4个独立功能单元：
  - 主整数单元
  - 浮点与整数乘法器
  - 浮点加法器
  - 浮点与整数除法器
- 假定这些功能单元的执行级没有实现流水化，那么前一条指令离开EX之前，不会发射任何一条指令，以避免同时回写的结构性冒险
- （图片）
- 事实上，可以流水化每一个功能部件，并允许多个指令同时进行。
- 定义功能单元的延迟以及启动间隔（重复间隔）
  - 延迟：生成结果的指令和使用结果指令之间的周期数
  - 启动间隔（重复间隔）：发出两个给定类型的操作之间必须间隔的周期数



## 改进的多配置流水线

### 流水线的结构

- 在以下改进的流水线结构中，浮点乘法、加法被流水化，可以同时执行4个浮点加、7个浮点乘和1个浮点除。

  ![IMG_0838](/Users/hubohan/Downloads/IMG_0838.jpg)

- 就需要设立ID/EX, ID/M1, ID/DIV, ID/A1等寄存器
- 指令顺序发射，可以同时执行（不同的时钟周期）

### 可能出现的冒险

- 结构冒险：除法单元没有流水化，可能需要阻塞除法单元
- 结构冒险：可能会同时要求写入寄存器
- 指令提交顺序不同，可能出现WAW冒险
- 不会存在WAR冒险（先读后写，读出旧值）
- 异常不精确
- RAW冒险会更加频繁：因为每一个操作的流水级变多，延迟变长，要等待的时钟周期变多了

> 冒险的类型复习：
>
> RAW, Read After Write, 表示写之后读出的**才是正确的**
>
> WAR, Write After Read, 表示读之后写才是正确的

#### 同时写寄存器的结构冒险的检测

- 跟踪ID级对于写端口的使用，在一条指令发射之前使其停顿：使用移位寄存器。这个寄存器指示任何已发射指令何时使用寄存器堆。如果待发射指令（ID中）和已发射指令需要同时使用，那么ID中的指令需要停顿一个周期，在每个时钟周期，这个寄存器会移动1位。**这种方法在ID级检测了冲突**
- 当一个冲突指令尝试进入MEM或者WB时，使其停顿。这样可能会导致多处Stall，还可能会导致EX, M7, A4, DIV同时被占用，stall返回流水线中

#### 潜在的WAW冒险

- 仅仅发生在有一条无用的指令需要被执行的时候
- 但是仍然需要检测
- 解决方法
  - 当检测到可能写同一个寄存器时，延迟后续指令的发射
  - 检测冒险，丢弃前一条指令的结果
- 由于是顺序发射，所以可以检测已发射的指令写的寄存器是否和待发射的指令需要写的寄存器相同



### 冒险的检测

- 检测结构冒险：等待需要的功能单元不忙，并确认寄存器写不冲突
- 检测RAW冒险：原寄存器不是在已发射指令中的目的寄存器
- 检测WAW冒险



### 精确异常的处理

#### 问题描述

考虑以下代码序列：

```assembly
DIV.D F0 F2 F4
ADD.D F10 F10 F8
SUB.D F12 F12 F14
```

指令顺序发射，但可能是乱序完成。

假设SUB.D引发了浮点运算异常，此时DIV.D还没有完成，ADD.D已经完成了（此处不存在冒险，允许乱序提交），此时可以通过清除流水线来实现。

然而如果DIV.D引发了异常，而ADD.D已经完成，此时难以恢复到异常发生之前的现场了。

#### 解决方法

- 忍受不精确异常：某种异常不被允许，或是交给其他硬件处理，继续执行，或是加上单独测试异常的指令
- 缓存指令执行的结果，直到之前发射的指令完成：缓冲区可能很大，电路比较复杂
  - 历史记录文件
  - 未来文件
- 记录足够的信息，例如每一条指令对应的PC，使用中断处理程序来处理
  - 假设有以下几条指令：
    - $Inst_1$ - 耗时很长的指令，最终导致中断，
    - $Inst_2-Inst_{n-1}$ - 还没完成的指令
    - $Inst_n$ - 已经完成的指令
  - 给定流水线中所有的PC，软件可以已完成的指令1和n，软件必须在中断处理结束之后，继续完成$Inst_2$到$Inst_{n-1}$，此后才从中断程序返回$Inst_{n+1}$的操作
- 只有在执行阶段的所有指令都不会造成异常时，才可以继续发射指令
  - 需要在EX级尽早确定是否会触发异常，减少等待时间



# 举例：MIPS R4000 流水线

- IF

  - 计算PC
  - 初始化Cache访问

- IS

  - 访问Cache

- RF

  - Cache命中检测
  - 指令译码
  - 寄存器访问
  - Hazard检测

- EX

  - 执行

- DF

  - 访问数据Cache

- DS

  - 访问数据Cache

- TC

  - 数据Cache命中检测

- WB

  - 回写

  --------

- Branch-Likely指令

- TBC

